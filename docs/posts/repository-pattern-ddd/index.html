<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z3Q5T40JTK"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z3Q5T40JTK")</script><meta name=robots content="index, follow"><title>DDD Repositories and Transactions | Minhaj Uddin Khan</title>
<meta name=keywords content="Go,DDD"><meta name=description content="Lessons learnt from writing repositories the non DDD way"><meta name=author content="Minhaj U. Khan"><link rel=canonical href=https://minhajthekhan.github.io/posts/repository-pattern-ddd/><meta name=google-site-verification content="G-Z3Q5T40JTK"><link crossorigin=anonymous href=/assets/css/stylesheet.d4c0c39ba784f8ddbf6ccd78b44563ef84dd23dca04a632446d64b7803f51391.css integrity="sha256-1MDDm6eE+N2/bM14tEVj74TdI9ygSmMkRtZLeAP1E5E=" rel="preload stylesheet" as=style><link rel=icon href=https://minhajthekhan.github.io/favicon_io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://minhajthekhan.github.io/favicon_io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://minhajthekhan.github.io/favicon_io/favicon-16x16.png><link rel=apple-touch-icon href=https://minhajthekhan.github.io/favicon_io/apple-touch-icon.png><link rel=mask-icon href=https://minhajthekhan.github.io/favicon_io/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://minhajthekhan.github.io/posts/repository-pattern-ddd/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="DDD Repositories and Transactions"><meta property="og:description" content="Lessons learnt from writing repositories the non DDD way"><meta property="og:type" content="article"><meta property="og:url" content="https://minhajthekhan.github.io/posts/repository-pattern-ddd/"><meta property="og:image" content="https://minhajthekhan.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-11-29T00:00:00+00:00"><meta property="article:modified_time" content="2024-11-29T00:00:00+00:00"><meta property="og:site_name" content="Minhaj Uddin Khan"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://minhajthekhan.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="DDD Repositories and Transactions"><meta name=twitter:description content="Lessons learnt from writing repositories the non DDD way"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://minhajthekhan.github.io/posts/"},{"@type":"ListItem","position":2,"name":"DDD Repositories and Transactions","item":"https://minhajthekhan.github.io/posts/repository-pattern-ddd/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"DDD Repositories and Transactions","name":"DDD Repositories and Transactions","description":"Lessons learnt from writing repositories the non DDD way","keywords":["Go","DDD"],"articleBody":"Let‚Äôs say you‚Äôre ordering a pizza online and you get to select the toppings for your pizza. To store this information, the website uses two database tables: pizzas and toppings.\nThe repositories to store these can be imagined like this:\n1 2 pizzaRepository.CreatePizza(ctx, pizza) toppingsRepository.CreateToppings(ctx, pizza.ID, toppings) Theres a catch when you make the order: if the above two operations don‚Äôt happen in a transaction, and the latter fails, you can expect the pizza to be delivered ‚Äî without toppings. üßë‚Äçüç≥\nTo fix this, a database transaction needs to be created and shared between the two repositories.\nA transaction can begin and be passed on to these repositories, and then finally commit or rollback given what happens to the operation.\n1 2 3 4 5 6 7 8 txn := s.transactionsFactory.Begin() pizzaRepository = s.pizzaRepository.WithTx(ctx, txn) toppingsRepository = s.toppingsRepository.WithTx(ctx, txn) pizzaRepository.CreatePizza(ctx, pizza) toppingsRepository.CreateToppings(ctx, pizza.ID, toppings) txn.Commit() All looks well and good, and it works. But (there is always a but), there are some design issue that come with it.\nMocks Lets talk about the tests.\nIn order to test this piece of code, you need to mock the following:\nthe transaction factory the transaction that the factory builds Adding a lot of boilerplate code to the tests can become annoying too quickly.\n1 2 3 4 5 6 7 8 txn := mocks.NewTransaction() transactionFactory := mocks.NewTransactionFactory() pizzaRepository := mocks.NewPizzaRepository() toppingsRepository := mocks.NewToppingsRepository() transactionFactory.EXPECT().Begin(any, any).Return(txn) pizzaRepository.EXPECT().WithTx(any, tx).Return(pizzaRepository) toppingsRepository.EXPECT().WithTx(any, tx).Return(toppingsRepository) Notice that all the code above does not test the actual business logic, rather just to mock a technical detail.\nIf you notice, theres a mock, that returns a mock on L6 - thaaaaat doesn‚Äôt sound very good.\nDependency Injections Lets try to imaging what the constructor for the code looks like:\n1 2 3 4 5 func NewPizzaOrderService( transactionFactory transactions.Factory, pizzaRepository repository.PizzaRepository, toppingsRepository repository.ToppingsRepository, ) Service {} as more dependencies go into the pizza ordering service, the constructor gets fatter. Your linter may start to hint that growing number of arguments aren‚Äôt nice.\nIf your function takes eleven parameters, you probably have forgotten one more.\nGoing against the Guidelines Be conservative in what you do, be liberal in what you accept from others - Jon Postel\nThe principle is also known as¬†Postel‚Äôs law, after¬†Jon Postel, who used the wording in an early specification of¬†TCP[1]. This same principle is also mentioned in the book 100 Go Mistakes and How to Avoid Them by¬†Teiva Harsanyi.\nBy this principle, we should be accepting abstractions (interfaces) and returning concrete implementations (structs)\nBack to our example:\n1 2 3 4 5 6 7 package repository type PizzaRepository interface { WithTx(ctx context.Context, tx ExecutorTx) PizzaRepository } func NewPizzaRepository() PizzaRepository { ... } To make this testable, the function‚Äôs return type has to be an abstraction (interface ) so that it can be mocked. If the function returns a concrete implementation, the mocks would fail because the return type expects to be a *Repository but is a *MockRepository\nTransactions outside Repositories Repositories hide infrastructure detail. A database transaction is the implementation detail that a repository should abstract. Say the database was not an SQL database with two tables, but a collection in a NoSQL database where pizza and toppings live in the same document. In that scenario, the service creating and passing the transactions aren‚Äôt valid anymore.\nThe service creating database transaction hinted for bad design.\nWhat went wrong? Repositories should not reflect the underlying database tables, but serve a way to interact with domain models.\nThe problem with our design is that we mapped a repository per database table.\nWe shouldn‚Äôt ask the repository to create a pizza row and create its pizza toppings rows, rather, we should ask the repository to save a pizza when its orderred.\nA pizza order can contain the pizza and its toppings together ‚Äî this is called an aggregate in the DDD world. Martin Fowler puts it in a simple words:\nA DDD aggregate is a cluster of domain objects that can be treated as a single unit. An example may be an order and its line-items, these will be separate objects, but it‚Äôs useful to treat the order (together with its line items) as a single aggregate.\n1 repository.SavePizzaOrder(ctx context.Context, pizzaOrder) Changing the way we think of the repository from tables to domain models fixes everything.\nThe extra mocks are gone because there is no transaction factory anymore. All the code related to transactions are now part of the repository ‚Äî which makes perfect sense as it encapsulates the lower level SQL details away from the service. 1 2 r := mocks.NewPizzaRepository() r.EXPECT().SavePizzaOrder(any, any).Return(nil) Lesser dependency injections to the service is now a reality, no more repositories and transaction factories as dependencies, rather a clean single repository. 1 func NewPizzaOrderService(r repository.Repository) { ... } We make Jon Postel happy and play by the book, by being conservative in what we do and liberal in what we expect. 1 func NewRepository(db ExecutorTx) *Repository { ... } ‚ÄúSimplicity is the ultimate sophistication.‚Äù ‚Äî Leonardo da Vinci\nUseful links: Design the infrastructure persistence layer\nMartin Fowler - Aggregates\nTransactions in Repository Layer\n","wordCount":"852","inLanguage":"en","image":"https://minhajthekhan.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2024-11-29T00:00:00Z","dateModified":"2024-11-29T00:00:00Z","author":[{"@type":"Person","name":"Minhaj U. Khan"}],"mainEntityOfPage":{"@type":"WebPage","@id":"https://minhajthekhan.github.io/posts/repository-pattern-ddd/"},"publisher":{"@type":"Organization","name":"Minhaj Uddin Khan","logo":{"@type":"ImageObject","url":"https://minhajthekhan.github.io/favicon_io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://minhajthekhan.github.io/ accesskey=h title="Home (Alt + H)"><img src=https://minhajthekhan.github.io/apple-touch-icon.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://minhajthekhan.github.io/about/ title=About><span>About</span></a></li><li><a href=https://minhajthekhan.github.io/posts/ title=Posts><span>Posts</span></a></li><li><a href=https://minhajthekhan.github.io/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://minhajthekhan.github.io/>Home</a>&nbsp;¬ª&nbsp;<a href=https://minhajthekhan.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">DDD Repositories and Transactions</h1><div class=post-description>Lessons learnt from writing repositories the non DDD way</div><div class=post-meta><span title='2024-11-29 00:00:00 +0000 UTC'>November 29, 2024</span>&nbsp;¬∑&nbsp;4 min&nbsp;¬∑&nbsp;852 words&nbsp;¬∑&nbsp;Minhaj U. Khan</div></header><div class=post-content><p>Let‚Äôs say you‚Äôre ordering a pizza online and you get to select the toppings for your pizza. To store this information, the website uses two database tables: pizzas and toppings.</p><p>The <a href=https://learn.microsoft.com/en-us/dotnet/architecture/microservices/microservice-ddd-cqrs-patterns/infrastructure-persistence-layer-design>repositories</a> to store these can be imagined like this:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>pizzaRepository</span><span class=p>.</span><span class=nf>CreatePizza</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>pizza</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>toppingsRepository</span><span class=p>.</span><span class=nf>CreateToppings</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>pizza</span><span class=p>.</span><span class=nx>ID</span><span class=p>,</span> <span class=nx>toppings</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>Theres a catch when you make the order: if the above two operations don‚Äôt happen in a transaction, and the latter fails, you can expect the pizza to be delivered ‚Äî without toppings. üßë‚Äçüç≥</p><p>To fix this, a database transaction needs to be created and shared between the two repositories.</p><p>A transaction can begin and be passed on to these repositories, and then finally commit or rollback given what happens to the operation.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>txn</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nx>transactionsFactory</span><span class=p>.</span><span class=nf>Begin</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nx>pizzaRepository</span> <span class=p>=</span> <span class=nx>s</span><span class=p>.</span><span class=nx>pizzaRepository</span><span class=p>.</span><span class=nf>WithTx</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>txn</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>toppingsRepository</span> <span class=p>=</span> <span class=nx>s</span><span class=p>.</span><span class=nx>toppingsRepository</span><span class=p>.</span><span class=nf>WithTx</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>txn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>pizzaRepository</span><span class=p>.</span><span class=nf>CreatePizza</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>pizza</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>toppingsRepository</span><span class=p>.</span><span class=nf>CreateToppings</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>pizza</span><span class=p>.</span><span class=nx>ID</span><span class=p>,</span> <span class=nx>toppings</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>txn</span><span class=p>.</span><span class=nf>Commit</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>All looks well and good, and it works. But <em>(there is always a but),</em> there are some design issue that come with it.</p><h2 id=mocks>Mocks<a hidden class=anchor aria-hidden=true href=#mocks>#</a></h2><p>Lets talk about the tests.</p><p>In order to test this piece of code, you need to mock the following:</p><ol><li>the transaction factory</li><li>the transaction that the factory builds</li></ol><p>Adding a lot of boilerplate code to the tests can become annoying too quickly.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>txn</span> <span class=o>:=</span> <span class=nx>mocks</span><span class=p>.</span><span class=nf>NewTransaction</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nx>transactionFactory</span> <span class=o>:=</span> <span class=nx>mocks</span><span class=p>.</span><span class=nf>NewTransactionFactory</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nx>pizzaRepository</span> <span class=o>:=</span> <span class=nx>mocks</span><span class=p>.</span><span class=nf>NewPizzaRepository</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nx>toppingsRepository</span> <span class=o>:=</span> <span class=nx>mocks</span><span class=p>.</span><span class=nf>NewToppingsRepository</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>transactionFactory</span><span class=p>.</span><span class=nf>EXPECT</span><span class=p>().</span><span class=nf>Begin</span><span class=p>(</span><span class=nx>any</span><span class=p>,</span> <span class=nx>any</span><span class=p>).</span><span class=nf>Return</span><span class=p>(</span><span class=nx>txn</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>pizzaRepository</span><span class=p>.</span><span class=nf>EXPECT</span><span class=p>().</span><span class=nf>WithTx</span><span class=p>(</span><span class=nx>any</span><span class=p>,</span> <span class=nx>tx</span><span class=p>).</span><span class=nf>Return</span><span class=p>(</span><span class=nx>pizzaRepository</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>toppingsRepository</span><span class=p>.</span><span class=nf>EXPECT</span><span class=p>().</span><span class=nf>WithTx</span><span class=p>(</span><span class=nx>any</span><span class=p>,</span> <span class=nx>tx</span><span class=p>).</span><span class=nf>Return</span><span class=p>(</span><span class=nx>toppingsRepository</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>Notice that all the code above does not test the actual business logic, rather just to mock a technical detail.</p><p>If you notice, theres a mock, that returns a mock on L6 - <em>thaaaaat</em> doesn‚Äôt sound very good.</p><h2 id=dependency-injections>Dependency Injections<a hidden class=anchor aria-hidden=true href=#dependency-injections>#</a></h2><p>Lets try to imaging what the constructor for the code looks like:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>NewPizzaOrderService</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=nx>transactionFactory</span> <span class=nx>transactions</span><span class=p>.</span><span class=nx>Factory</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>pizzaRepository</span> <span class=nx>repository</span><span class=p>.</span><span class=nx>PizzaRepository</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>toppingsRepository</span> <span class=nx>repository</span><span class=p>.</span><span class=nx>ToppingsRepository</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=nx>Service</span> <span class=p>{}</span>
</span></span></code></pre></td></tr></table></div></div><p>as more dependencies go into the pizza ordering service, the constructor gets fatter. Your linter may start to hint that growing number of arguments aren‚Äôt nice.</p><blockquote><p><em>If your function takes eleven parameters, you probably have forgotten one more.</em></p></blockquote><h2 id=going-against-the-guidelines>Going against the Guidelines<a hidden class=anchor aria-hidden=true href=#going-against-the-guidelines>#</a></h2><blockquote><p><em>Be conservative in what you do, be liberal in what you accept from others - Jon Postel</em></p></blockquote><p>The principle is also known as¬†<strong>Postel&rsquo;s law</strong>, after¬†<a href=https://en.wikipedia.org/wiki/Jon_Postel>Jon Postel</a>, who used the wording in an early specification of¬†<a href=https://en.wikipedia.org/wiki/Transmission_Control_Protocol>TCP</a><a href=https://en.wikipedia.org/wiki/Robustness_principle#cite_note-1>[1]</a>. This same principle is also mentioned in the book <a href=https://www.oreilly.com/library/view/100-go-mistakes/9781617299599/>100 Go Mistakes and How to Avoid Them</a> by¬†Teiva Harsanyi.</p><p>By this principle, we should be accepting abstractions <em>(interfaces)</em> and returning concrete implementations <em>(structs)</em></p><p>Back to our example:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>repository</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>PizzaRepository</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nf>WithTx</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>tx</span> <span class=nx>ExecutorTx</span><span class=p>)</span> <span class=nx>PizzaRepository</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>NewPizzaRepository</span><span class=p>()</span> <span class=nx>PizzaRepository</span> <span class=p>{</span> <span class=o>...</span> <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>To make this testable, the function‚Äôs return type has to be an abstraction (<code>interface</code> ) so that it can be mocked. If the function returns a concrete implementation, the mocks would fail because the return type expects to be a <code>*Repository</code> but is a <code>*MockRepository</code></p><h2 id=transactions-outside-repositories>Transactions outside Repositories<a hidden class=anchor aria-hidden=true href=#transactions-outside-repositories>#</a></h2><p>Repositories hide infrastructure detail. A database transaction is the implementation detail that a repository should abstract. Say the database was not an SQL database with two tables, but a collection in a NoSQL database where pizza and toppings live in the same document. In that scenario, the service creating and passing the transactions aren&rsquo;t valid anymore.</p><p>The service creating database transaction hinted for bad design.</p><hr><h2 id=what-went-wrong>What went wrong?<a hidden class=anchor aria-hidden=true href=#what-went-wrong>#</a></h2><p><em><strong>Repositories should not reflect the underlying database tables, but serve a way to interact with domain models.</strong></em></p><p>The problem with our design is that we mapped a repository per database table.</p><p>We shouldn‚Äôt ask the repository to create a pizza row and create its pizza toppings rows, rather, we should ask the repository to save a pizza when its orderred.</p><p>A pizza order can contain the pizza and its toppings together ‚Äî this is called an <a href=https://martinfowler.com/bliki/DDD_Aggregate.html>aggregate</a> in the DDD world. Martin Fowler puts it in a simple words:</p><blockquote><p><em>A DDD aggregate is a cluster of domain objects that can be treated as a single unit. An example may be an order and its line-items, these will be separate objects, but it&rsquo;s useful to treat the order (together with its line items) as a single aggregate.</em></p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>repository</span><span class=p>.</span><span class=nf>SavePizzaOrder</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>pizzaOrder</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>Changing the way we think of the repository from <em>tables</em> to <em>domain models</em> fixes everything.</p><ul><li>The extra mocks are gone because there is no transaction factory anymore. All the code related to transactions are now part of the repository ‚Äî which makes perfect sense as it encapsulates the lower level SQL details away from the service.</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>r</span> <span class=o>:=</span> <span class=nx>mocks</span><span class=p>.</span><span class=nf>NewPizzaRepository</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nx>r</span><span class=p>.</span><span class=nf>EXPECT</span><span class=p>().</span><span class=nf>SavePizzaOrder</span><span class=p>(</span><span class=nx>any</span><span class=p>,</span> <span class=nx>any</span><span class=p>).</span><span class=nf>Return</span><span class=p>(</span><span class=kc>nil</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>Lesser dependency injections to the service is now a reality, no more repositories and transaction factories as dependencies, rather a clean single repository.</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>NewPizzaOrderService</span><span class=p>(</span><span class=nx>r</span> <span class=nx>repository</span><span class=p>.</span><span class=nx>Repository</span><span class=p>)</span> <span class=p>{</span> <span class=o>...</span> <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>We make Jon Postel happy and play by the book, by being conservative in what we do and liberal in what we expect.</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>NewRepository</span><span class=p>(</span><span class=nx>db</span> <span class=nx>ExecutorTx</span><span class=p>)</span> <span class=o>*</span><span class=nx>Repository</span> <span class=p>{</span> <span class=o>...</span> <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>&ldquo;Simplicity is the ultimate sophistication.&rdquo; ‚Äî Leonardo da Vinci</p><h3 id=useful-links>Useful links:<a hidden class=anchor aria-hidden=true href=#useful-links>#</a></h3><ul><li><p><a href=https://learn.microsoft.com/en-us/dotnet/architecture/microservices/microservice-ddd-cqrs-patterns/infrastructure-persistence-layer-design>Design the infrastructure persistence layer</a></p></li><li><p><a href=https://martinfowler.com/bliki/DDD_Aggregate.html>Martin Fowler - Aggregates</a></p></li><li><p><a href=https://www.reddit.com/r/golang/comments/xe2zk4/transactions_in_repository_layer/>Transactions in Repository Layer</a></p></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://minhajthekhan.github.io/tags/go/>Go</a></li><li><a href=https://minhajthekhan.github.io/tags/ddd/>DDD</a></li></ul><nav class=paginav><a class=prev href=https://minhajthekhan.github.io/posts/cleanly-misaligned/><span class=title>¬´ Prev</span><br><span>Cleanly Misaligned</span>
</a><a class=next href=https://minhajthekhan.github.io/posts/google-devfest/><span class=title>Next ¬ª</span><br><span>Afterthoughts - The Myths about Testing</span></a></nav></footer><script src=https://utteranc.es/client.js repo=minhajthekhan/minhajthekhan.github.io issue-term=pathname theme=github-light crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2025 <a href=https://minhajthekhan.github.io/>Minhaj Uddin Khan</a></span> ¬∑
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>